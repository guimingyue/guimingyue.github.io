---
layout: post
title: 协程简介
category: Coroutine
---

最近几年，协程渐渐成为各种编程语言的一个重要的特性，Go 语言在早期就提供了其协程实现 Goroutine，C++ 20 也定义了其协程的标准，Java 语言也终于在 Java 19 中推出了其协程的实现 Virtual Thread。

## 协程是什么
协程一直没有一个统一的定义，但是一般说到的协程都是指可以暂停和恢复的函数。在程序中，函数一般来说，只有从开始执行和执行结束，中间是无法暂停的，那么为什么要将一个函数暂停呢？简单来说就是为了提高计算机的资源（内存，CPU）利用率。在多核时代，多线程技术是提高计算机利用率的主要手段，当一个线程某些原因（比如 IO )而阻塞时，线程就无法继续运行，那么操作系统会调度其他线程运行，这样 CPU 就会保持运行。但是对于操作系统来说，线程切换是有成本的，如果频繁的发生线程切换，那也是一笔不小的开销。另一方面，操作系统在分配线程时，也需要为线程分配其内存栈，也有一定的内存开销，所以一个操作系统能够创建的线程数量也是有限的。
对于多数 IO 密集型的应用（比如 Web 应用服务器Tomcat），一般采用一个线程对应一个请求的方式，但是对于 IO 密集型的应用，大多数时间都在阻塞等待 IO 事件的完成，而在等待过程中，线程却一直被占用着，有限的线程没有发挥出其应有的能力，而线程数过多也带来了一笔不小的 CPU 切换开销。
那如何解决该问题呢？试想，如果线程不是由操作系统创建的，而是在用户态创建并且调度的，是不是就能解决线程的问题了呢？从这个角度来讲，协程就是用户态的线程，它在用户态创建，运行在线程之上，由编程语言的运行时调度器进行调度。

## 协程的使用


## Reference

* [JEP 425: Virtual Threads (Preview)](https://openjdk.org/jeps/436)
* [Kotlin Coroutines: Design and Implementation](https://dl.acm.org/doi/pdf/10.1145/3486607.3486751)
