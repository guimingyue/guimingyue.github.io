---
layout: post
title: 协程简介
category: Coroutine
---

最近几年，协程渐渐成为各种编程语言的一个重要的特性，Go 语言在早期就提供了其协程实现 Goroutine，C++ 20 也定义了其协程的标准，Java 语言也终于在 Java 19 中推出了其协程的实现 Virtual Thread。

## 多线程的困境
在多核时代，多线程技术是提高计算机利用率的主要手段，当一个线程某些原因（比如 IO )而阻塞时，线程就无法继续运行，那么操作系统会调度其他线程运行，这样 CPU 就会保持运行。但是对于操作系统来说，线程切换是有成本的，如果频繁的发生线程切换，那也是一笔不小的开销。另一方面，操作系统在分配线程时，也需要为线程分配其内存栈，也有一定的内存开销，所以一个操作系统能够创建的线程数量也是有限的。
对于多数 IO 密集型的应用（比如 Web 应用服务器Tomcat），一般采用一个线程对应一个请求的方式，但是对于 IO 密集型的应用，大多数时间都在阻塞等待 IO 事件的完成，而在等待过程中，线程却一直被占用着，有限的线程没有发挥出其应有的能力，而线程数过多也带来了一笔不小的 CPU 切换开销。

## 异步编程
为了有效的利用资源，可以将一个线程处理一个请求的处理方式改为异步处理。最简单的异步处理的场景是：假设一个请求会有多次 IO 操作，如果几次 IO 操作都进行同步处理，那么 IO 处理的总时间为这几次 IO 时间的总和，但是如果能将这几次 IO 处理并行化，那 IO 处理的总时间则为 IO 处理中最长时间的一次 IO 时间，对于请求处理线程，在 IO 的时候，还可以处理不依赖 IO 结果的操作，这将大大减少这次请求处理的总时间，如下面一段代码所示。

```java
Future<Response1> f1 = ioRequest1();
Future<Response1> f2 = ioRequest1();

execSome();

computeResult(f1.get(), f2.get());
```

异步编程可以改善资源利用率，但是也会存在代码不容易理解，部分异步模型会导致排查问题不方便，所以需要探索更合适的异步编程方案。

## 协程
协程也是一种异步编程的方式，一般来说它是指可以一段暂停和恢复的函数。一般来说，函数只有从开始执行和执行结束，中间是无法暂停的，那么为什么要
暂停函数呢？为了提高计算机的资源利用率。从前文可以知道，线程会有切换开销和内存占用的开销，那如果线程不是由操作系统创建的，而是在用户态根据需求创建并且调度的，那就可以解决使用线程的问题。从这个角度来讲，协程就是用户态的线程，它在用户态创建，运行在线程之上，由编程语言的运行时调度器进行调度。当函数（协程）执行到一段 IO 这样耗时的操作时，就可以让出线程资源，等待 IO 完成后继续被调度到。

协程还是会由操作系统的线程来执行，而线程则是在处理器上执行的，所以协程，线程和处理器的关系可以用下图表示。
![coroutine-thread-processor](/images/coroutine/processor-thread-coroutine.drawio.png)


## 协程的使用


## 总结
本文首先从计算机资源利用率的角度分析了多线程的存在的问题，异步编程可以解决多线程的问题，协程也是一部编程的一种形态
## Reference

* [JEP 425: Virtual Threads (Preview)](https://openjdk.org/jeps/436)
* [Kotlin Coroutines: Design and Implementation](https://dl.acm.org/doi/pdf/10.1145/3486607.3486751)
