---
layout: post
title: Raft 论文阅读笔记
category: Raft
---

## 1. 介绍

由于一致性算法可以让一个集群在有部分机器宕机的情况下继续工作，所以它在构建可靠的大型软件系统方面扮演着重要的角色。Paxos 算法在过去十年一直是一致性算法中的焦点，大部分的一致性算法的实现都是基于 Paxos 的，并且 Paxos 算法已经成为了教授一致性算法的主要的工具。但是 Paxos 同样以难以理解著称。
通过学习和参考 Paxos 算法，我们设计了 Raft 算法，它比 Paxos 更容易理解和实现。Raft 算法主要有一下特性：

* Strong leader，Raft 集群中只有一个主节点，所有的日志都是从主节点流向其他节点。
* Leader election，Raft 使用随机的计时器来选主，这种机制在心跳的基础上增加了少量的复杂度，但是它能更简单和迅速的解决冲突。
* Membership changes，Raft 使用了一种称为 joint consensus 的方法来改变集群节点，`where the majorities of
two different configurations overlap during transitions`。这使得整个集群在配置改变的过程中能继续工作。

## 2. 复制状态机

一致性算法伴随着复制状态机出现，这个算法中，状态机在一组服务器上计算相同的副本的同一个状态，并且能够在部分机器宕机的情况下继续工作。复制状态机用于解决分布式系统中的各种容错问题。比如，像 GFS，HDFS，RAMCloud 这样的大型系统中，都有一个主节点的集群，它们使用一个单独的复制状态机来处理选主和存储配置信息，以防止主节点宕机。这样的复制状态机包括 Chubby 和 ZooKeeper。

典型的复制状态机使用复制日志来实现，如图1 所示。每个节点存储的日志包含一些列的命令，每个节点上的日志包含相同的命令，并且命令的顺序也相同，所以每个状态机处理相同序列的命令。

[图1](/images/raft_paper_notes/figure1-replicated-state-machine.png)

一致性算法的作用是使得复制日志保持一致性。服务节点上的一致性模块从客户端接收命令，然后将命令添加到它的日志中。服务节点上的一致性模块它与其他服务节点上的的一致性模块通信，并且保证日志最终包含相同的顺序的请求，即使部分节点宕机。一旦命令顺利复制了，每个服务节点上的状态机都能按照日志的顺序处理他们，最终将结果返回给客户端。所以，这些服务节点表现的像一个单一的，高可用的状态机。


实际的应用中的一致性算法主要有以下特性：

* 安全性，不会返回错误的结果。
* 可用性，只要保持大多数服务节点正常。
* 不依赖时间来保持一致性。
* 一旦多数的节点完成命令执行，少数的节点失败不影响整体性能。


## 3. Paxos 存在什么问题？

在过去的十年中，Paxos 协议成为了一致性的代名词，它首先定义了一个能够在单个提议上达成一致决定的协议，比如单条日志复制，这也称为`single-decree Paxos`。然后，Paxos 又定义了能够对连续的多个提议达成一致的版本，称为 `multi-Paxos`。Paxos 协议的正确性在理论上是成立的，它保证了集群节点的安全性和存活性，并且支持集群节点的变更。

但是 Paxos 有两个比较明显的缺点，首先是它以难以理解著称，其次是它并没有考虑如何来实现这个协议，比如大家对`multi-Paxos`算法，并没有一致的结论，Paxos 协议的作者主要在介绍`single-decree Paxos`，对`multi-Paxos`只是做了大致的描述。

基于 Paxos 的问题，我们觉得 Paxos 并没有为系统实现和教授提供一个好的基础，考虑到一致性在大型分布式软件系统中的重要性，我们设计了 Raft 协议。

## 4. 考虑可理解性的协议设计

新协议最重要的目标和最难的挑战是可理解性，它必须对大多数人来说是易懂的。

## 5. Raft 一致性算法

Raft 算法是用来管理日志复制的（第 2 部分描述）。该算法首先会选举一个主节点，然后由主节点来管理复制日志，基于这样的策略，它实现了一致性。

主节点从客户端接收日志（命令），再复制到其他节点上，其他节点能放心的将日志应用于状态机中。设计一个主节点能简化日志的复制。比如，主节点能决定如何应用日志，而不用依赖其他节点，并且数据流向只能是从主节点到其他节点。主节点宕机了，会再发起一个选择新主节点的流程。基于主节点的设计，Raft 将一致性问题划分成了三个相对独立的子问题：

* Leader election，主节点选举。
* Log replication，日志复制，由主节点从客户端接收日志，然后复制到其他节点。
* Safety，简单点理解是，如果一个节点对决策问题的一个提议达成了一致，并且应用到了状态机，那么不会接收这次决策问题的其他提议。

### 5.1 Raft 基础

一个 Raft 集群包含多个机器，典型的是 5 个，这样就能够承受有两个节点宕机的风险。在任何时间点一个节点只能是`leader`，`follower`和 `candidate`这三种状态中的一个，并且只会有不超过一个 `leader`。`follower`只能从`leader`接收请求并响应。

Raft 将时间划分为 term。













